//require('dotenv').load();
process.env.JWT_SECRET="-----BEGIN RSA PRIVATE KEY-----\n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\n-----END RSA PRIVATE KEY-----â€”";
process.env.PUBLIC_KEY="-----BEGIN PUBLIC KEY-----\nMIICIjANBgkqhkiG9w0BAQEFAAOCAg8AMIICCgKCAgEApCFg0utVGlYKZ2qPJ++y\nuIwF1nYpYZ9a7oNxR/twilJ5Frg17swCFwo78SsEZWw1Uexj7HDamvUI5+CCIAKN\noiodYHl6mRJxVUlQoVo/NgwKrg6M/ZHgFQq0dfE9Sg4M2SUCQmh6fqy9B1ItVDY+\nHt5aZrl/AE7KdfHFwWNUT2kGkq1qpulNfJi4mcSfqGfX0rtxZriRFQpLheJWnaB4\ntNliDDuCZNYtWpsuWHNKqRi3vDuMqwlWuHTiXwUPi5+/YKW2Edl5rq7oWFseKhYT\nF3X/O14NuKOmu9Hku4v0H2XPrLO6jovsJG/z61bxsMkY8bHY0ZmbFjEDRRz7DZTz\nAB5TQkKXwF4shlkspzs/Yp/T0ppuWrJH0XffDpkJkVGTTznMvMF47vEdR33ty/Ns\nAPhPf/mNXkyq6pwV63SFc4FfoHWhzgdo0Kv/TRzYBWthHzWuFvoZVgPm6i9Kqv0Z\nujck59EcCOUPSlUwmzSLwDlNeJuM1uNXq0ahSYjuqArLZhIOicutYjOb3s9cNOpi\nSmKBGeQ4M6TNqrtB+ja1jpDH/i8QkjGOwzAjwHpoxqzymCsuiB+FK5VZUTKN2kJy\np/+UGaZpB1IyC/bGJzcBuVBZMPLRxixeezb4rdG7sc46ckCLFghojL+eY59JWwlx\nFwWMk6VbNfqWWusnWoRNwekCAwEAAQ==\n-----END PUBLIC KEY-----";
const db = require('./models/db.model');
const express = require('express');
const passport= require('passport');
var cors = require('cors');
const bodyParser = require('body-parser');

const usersRoute = require('./routes/users.route');
const tablesRoute= require('./routes/tables.route');
const ordersRoute= require('./routes/orders.route');
const menuRoute= require('./routes/menu.route');

const app=express();
const port=process.env.PORT || 3000;

const server = require('http').Server(app);
const socketioJwt=require('socketio-jwt');
global.io = require('socket.io')(server);
global.socketUsers=[];

const config = require('./config/passport.config');

server.listen(port,()=>console.log(`lisening on port ${port} allah uh akbar`));

app.use(cors({
    origin: function(origin, callback){
      return callback(null, true);
    },
    optionsSuccessStatus: 200,
    credentials: true
  }));

// log in console the port where the app is litsening
//app.listen(port,()=>console.log(`lisening on port ${port} allah uh akbar`));
/*socket part */
  io.on('connection', socketioJwt.authorize({
    secret: process.env.PUBLIC_KEY,
    timeout: 0 // 15 seconds to send the authentication message
  })).on('authenticated', function(socket) {
    //this socket is authenticated, we are good to handle more events from it.
    console.log('hello! ' + socket.decoded_token.username);

    socket.on('booked_table',function(){
      console.log("table booked"); 
      socket.broadcast.emit('update_tables');
    });

    socket.on('kitchenOrder',function(){
      console.log('kitchen order message');
      socket.broadcast.emit('update_kitchenOrders');
    });

    socket.on('barOrder',function(){
      console.log('bar order message');
      socket.broadcast.emit('update_barOrders');
    });

    socket.on('kitchenOrderReady',function(){
      socket.broadcast.emit('update_kitchenMessages');
    });

    socket.on('barOrderReady',function(){
      socket.broadcast.emit('update_barMessages');
    })

    socket.on('deleted_user',function(){
      console.log("deleted user");
      socket.broadcast.emit('update_users');
    })

    socket.on('updated_user',function(){
      socket.broadcast.emit('update_users');
    })
  
    socket.on('disconnect', function() {
      console.log("Bye bye " + socket.decoded_token.username)
      //delete global.userSocket[user];
    });

    
  });

// inizializiamo passoport
app.use(passport.initialize());

// allowing app to use body parser
app.use(bodyParser.json());

//adding routes
app.use(tablesRoute);
app.use(usersRoute);
app.use(menuRoute);
app.use(ordersRoute);


//handling unexisting api request
app.use((req,res,next)=>{
    res.status(404).send("Ti sei perso ...");
});

//handling internal server errors
app.use((err,req,res,next)=>{
    console.error(err.stack);
    res.status(500);
});



